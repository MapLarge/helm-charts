{{- if gt .Values.replicas 1}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "maplarge.name" . }}-version-check
  annotations:
    "helm.sh/hook": pre-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-weight": "0"
spec:
  backoffLimit: 0
  template:
    spec:
      {{- if .Values.image.pullSecretName }}
      imagePullSecrets:
        - name: {{ .Values.image.pullSecretName }}
      {{- if .Values.image.extraPullSecrets -}}
      {{- toYaml .Values.image.extraPullSecrets | nindent 8 }}
      {{- end }}
      {{- end }}
      serviceAccountName: {{ include "maplarge.name" . }}-update-hook
      restartPolicy: Never
      volumes:
        - name: workdir
          emptyDir: {}

      initContainers:
        - name: get-new-version
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          volumeMounts:
            - name: workdir
              mountPath: /workdir
          command: ["/bin/sh", "-c"]
          args:
            - |
              cat /opt/maplarge/server/version.txt > /workdir/new_version.txt
      containers:
        - name: compare-and-scale
          image: "{{ .Values.hooks.preUpgradeHook.image.repository }}:{{ .Values.hooks.preUpgradeHook.image.tag }}"
          volumeMounts:
            - name: workdir
              mountPath: /workdir
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -e
              STS_NAME="{{ include "maplarge.name" . }}"
              NAMESPACE="{{ .Release.Namespace }}"

              NEW_RAW=$(cat /workdir/new_version.txt | tr -d '\n')

              if ! kubectl get sts $STS_NAME -n $NAMESPACE > /dev/null 2>&1; then
                  echo "StatefulSet not found. Fresh install. Skipping."
                  exit 0
              fi

              echo "Checking currently running version..."
              OLD_RAW=$(kubectl exec $STS_NAME-0 -n $NAMESPACE -- cat /opt/maplarge/server/version.txt | tr -d '\n')

              echo "Raw Versions: Old='$OLD_RAW', New='$NEW_RAW'"

              get_build_id() {
                echo "$1" | cut -d. -f4 | cut -d- -f1
              }

              is_int() {
                case $1 in
                    ''|*[!0-9]*) return 1 ;;
                    *) return 0 ;;
                esac
              }

              NEW_BUILD=$(get_build_id "$NEW_RAW")
              OLD_BUILD=$(get_build_id "$OLD_RAW")

              echo "Parsed Build IDs: Old='$OLD_BUILD', New='$NEW_BUILD'"

              if ! is_int "$NEW_BUILD" || ! is_int "$OLD_BUILD"; then
                  echo "FORMAT CHANGE DETECTED: One or both versions do not match the 4-part dot schema."
                  echo "Treating this as a structural upgrade. Scaling down to 0 to ensure clean state..."

                  kubectl scale sts $STS_NAME -n $NAMESPACE --replicas=0

                  echo "Waiting for pods to terminate..."
                  kubectl wait --for=delete pod -l app.kubernetes.io/instance={{ .Release.Name }} --timeout=300s
                  echo "Cluster scaled down. Helm will now bring up new pods."
              elif [ "$NEW_BUILD" -lt "$OLD_BUILD" ]; then
                  # --- DOWNGRADE PROTECTION ---
                  MSG="BLOCKING DOWNGRADE: Target version ($NEW_BUILD) is older than current version ($OLD_BUILD). Downgrades are not supported via this pipeline. Aborting Helm upgrade."
                  echo "$MSG"
                  echo "$MSG" > /dev/termination-log
                  exit 1
              elif [ "$NEW_BUILD" != "$OLD_BUILD" ]; then
                  echo "MISMATCH DETECTED! ($OLD_BUILD -> $NEW_BUILD)"
                  echo "Scaling down to 0 to perform clean upgrade..."

                  kubectl scale sts $STS_NAME -n $NAMESPACE --replicas=0

                  echo "Waiting for pods to terminate..."
                  kubectl wait --for=delete pod -l app.kubernetes.io/instance={{ .Release.Name }} --timeout=300s
                  echo "Cluster scaled down."
              else
                  echo "Build IDs match ($OLD_BUILD). Standard rolling update is safe."
              fi
{{- end }}
